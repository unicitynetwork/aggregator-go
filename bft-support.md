# BFT Support for Unicity Aggregator

## Overview

The Unicity Aggregator supports Byzantine Fault Tolerance (BFT) through integration with the Alphabill BFT core. This enables the aggregator to participate in a distributed consensus network where nodes can continue to operate correctly even if some nodes fail or act maliciously.

## Requirements for BFT Support

### Prerequisites

1. **Alphabill BFT Core**: The BFT functionality depends on the Alphabill BFT core library
2. **Go Dependencies**: Ensure all BFT-related dependencies are available:
   ```
   github.com/alphabill-org/alphabill-go-base
   go.opentelemetry.io/otel/metric
   go.opentelemetry.io/otel/trace
   ```

### Configuration Files

For BFT support, you need to provide BFT-specific configuration files generated by the BFT core:

#### Required Configuration Files

1. **Shard Configuration** (`bft-config/shard-conf-7_0.json`)
   - Generated using BFT core for "Unicity node" (a custom BFT partition)
   - Contains network topology and node information
   - Defines the shard structure and participant nodes

2. **Key Configuration** (`bft-config/keys.json`)
   - Contains cryptographic keys for the BFT node
   - Includes public/private key pairs for consensus participation
   - Must be kept secure and not shared publicly

3. **Trust Base Configuration** (`bft-config/trust-base.json`)
   - Defines the initial trust relationships in the network
   - Contains root certificates or trusted node identities
   - Used for initial network bootstrap and validation

### Configuration File Generation

Use the Alphabill BFT core tools to generate the required configuration files:

# Generate shard configuration for Unicity node in BFT core
`./setup-nodes.sh -r 3 -u 1`

# Copy shard configuration for Unicity node
`cp <bftcore location>/test-nodes/shard-conf-7_0.json bft-config/shard-conf-7_0.json`
# Copy key configuration
`cp <bftcore location>/test-nodes/unicity1/keys.json bft-config/keys.json`
# Copy trust base configuration  
`cp <bftcore location>/test-nodes/trust-base.json bft-config/trust-base.json`


### Environment Variable Overrides

The aggregator automatically picks up configuration files from the default locations. You can override these paths using environment variables:

- `BFT_KEY_CONF_FILE`: Override path to keys.json
- `BFT_SHARD_CONF_FILE`: Override path to shard configuration file
- `BFT_TRUST_BASE_FILE`: Override path to trust-base.json

Example:
```bash
export BFT_KEY_CONF_FILE=/custom/path/keys.json
export BFT_SHARD_CONF_FILE=/custom/path/shard-conf.json
export BFT_TRUST_BASE_FILE=/custom/path/trust-base.json
```

### Network Requirements

1. **Network Connectivity**: All BFT nodes must be able to communicate with each other
2. **Port Configuration**: Ensure required ports are open for BFT communication
3. **Time Synchronization**: All nodes should have synchronized clocks (NTP recommended)
4. **Firewall Rules**: Configure firewalls to allow BFT traffic between nodes

### Building with BFT Support

To build the aggregator with BFT support, ensure all dependencies are available:

```bash
go mod tidy
go build ./cmd/aggregator
```

**Note**: BFT functionality is currently optional. The aggregator can run without BFT dependencies for development and testing purposes.

### Troubleshooting

1. **Missing Dependencies**: If BFT dependencies are unavailable, the aggregator will build without BFT support
2. **Configuration Errors**: Check that all configuration files are valid JSON and contain required fields
3. **Network Issues**: Verify network connectivity between BFT nodes
4. **Key Validation**: Ensure cryptographic keys are valid and compatible with the BFT network