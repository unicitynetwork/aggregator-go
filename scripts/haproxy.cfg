global
    log stdout local0
    maxconn 4000
    daemon

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Stats interface
stats enable
stats uri /haproxy-stats
stats refresh 30s
stats show-node

# Health check endpoint for HAProxy itself
frontend health_check
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-desc HAProxy load balancer for Aggregator services

# Main frontend for aggregator services
frontend aggregator_frontend
    bind *:3000
    # Add request ID for tracking
    unique-id-format %{+X}o\ %ci:%cp_%fi:%fp_%Ts_%rt:%pid
    unique-id-header X-Request-ID

    # Capture request and response for logging
    capture request header User-Agent len 128
    capture request header Content-Type len 64

    # Route to backend
    default_backend aggregator_backend

# Backend configuration for aggregator services
backend aggregator_backend
    # Load balancing algorithm
    balance roundrobin

    # Sticky sessions based on source IP (optional, can be removed for pure round-robin)
    # stick-table type ip size 100k expire 30m
    # stick on src

    # Health check configuration
    option httpchk GET /health
    http-check expect status 200

    # Backend servers
    server aggregator1 aggregator-1:3001 check inter 5s fall 3 rise 2 weight 100
    server aggregator2 aggregator-2:3002 check inter 5s fall 3 rise 2 weight 100

    # Add response headers for debugging
    http-response set-header X-Backend-Server %s
    http-response set-header X-HAProxy-Server-ID %si
