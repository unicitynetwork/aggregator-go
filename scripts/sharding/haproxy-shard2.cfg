global
    log stdout local0
    maxconn 4000
    daemon

# Docker DNS resolver for dynamic service discovery
resolvers docker_resolver
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold valid 10s
    hold obsolete 30s

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Stats interface
stats enable
stats uri /haproxy-stats
stats refresh 30s
stats show-node

# Health check endpoint for HAProxy itself
frontend health_check
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-desc HAProxy load balancer for Shard 2 Aggregator services

# Main frontend for shard 2 aggregator services
frontend shard2_frontend
    bind *:3000
    # Add request ID for tracking
    unique-id-format %{+X}o\ %ci:%cp_%fi:%fp_%Ts_%rt:%pid
    unique-id-header X-Request-ID

    # Capture request and response for logging
    capture request header User-Agent len 128
    capture request header Content-Type len 64

    # Route to backend
    default_backend shard2_backend

# Backend configuration for shard 2 aggregator services
backend shard2_backend
    # Load balancing algorithm - round robin
    balance roundrobin

    # Sticky sessions based on source IP for session affinity
    stick-table type ip size 100k expire 30m
    stick on src

    # Health check configuration
    option httpchk GET /health
    http-check expect status 200

    # Cleanup connections when backend is marked down
    option redispatch
    option abortonclose

    # Backend servers with health check parameters
    # inter 2s = check every 2 seconds
    # fastinter 1s = check every 1 second when transitioning
    # downinter 5s = check every 5 seconds when down
    # fall 2 = mark DOWN after 2 failed checks
    # rise 2 = mark UP after 2 successful checks
    # on-marked-down shutdown-sessions = close existing sessions when backend fails
    server shard2-node1 aggregator-shard2-1:3000 check inter 2s fastinter 1s downinter 5s fall 2 rise 2 on-marked-down shutdown-sessions weight 100 resolvers docker_resolver init-addr last,libc,none
    server shard2-node2 aggregator-shard2-2:3000 check inter 2s fastinter 1s downinter 5s fall 2 rise 2 on-marked-down shutdown-sessions weight 100 resolvers docker_resolver init-addr last,libc,none

    # Add response headers for debugging
    http-response set-header X-Backend-Server %s
    http-response set-header X-HAProxy-Server-ID %si
