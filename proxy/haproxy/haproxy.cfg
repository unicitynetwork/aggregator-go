global
    log stdout format raw local0
    # For extra security, we'll use a DH-Params file
    ssl-dh-param-file /etc/letsencrypt/ssl-dhparams.pem
    # Modern secure SSL settings
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

# User authentication for /logs endpoint
# Password hash is set via DOZZLE_PASSWORD_HASH environment variable
# Generate hash: openssl passwd -6 "yourpassword"
userlist dozzle_users
    user admin password ${DOZZLE_PASSWORD_HASH}

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  50s
    timeout server  50s

frontend http_frontend
    bind *:80
    # Allow ACME challenge requests for Let's Encrypt certificate renewal
    acl letsencrypt_acl path_beg /.well-known/acme-challenge/
    # Redirect all other HTTP traffic to HTTPS
    redirect scheme https code 301 if !letsencrypt_acl
    # Serve ACME challenges
    use_backend letsencrypt_backend if letsencrypt_acl

frontend https_frontend
    # Bind to port 443 and use the combined certificate file
    bind *:443 ssl crt /etc/letsencrypt/live/goggregator-test.unicity.network/haproxy.pem alpn h2,http/1.1

    mode http

    # Add a good security header
    http-response set-header Strict-Transport-Security "max-age=16000000; includeSubDomains; preload;"

    # Route logs/dozzle requests with authentication
    acl logs_acl path_beg /logs
    acl logs_auth http_auth(dozzle_users)
    http-request auth realm "Logs Access" if logs_acl !logs_auth
    use_backend dozzle_app if logs_acl

    # Route faucet requests to faucet backend
    acl faucet_api_acl path_beg /api/v1/faucet
    acl faucet_acl path_beg /faucet
    use_backend faucet_app if faucet_api_acl
    use_backend faucet_app if faucet_acl

    # By default, send all traffic to your application backend
    default_backend goggregator_app

backend goggregator_app
    # Forward traffic to your application running on localhost port 3000
    server app1 127.0.0.1:3000 check

backend faucet_app
    # Forward faucet requests to faucet service on port 8081
    server faucet1 127.0.0.1:8081 check

backend dozzle_app
    # Forward logs requests to dozzle on localhost port 8088
    # Dozzle is configured with DOZZLE_BASE=/logs so we keep the prefix
    server dozzle1 127.0.0.1:8088 check

backend letsencrypt_backend
    # Serve ACME challenges from webroot directory
    server letsencrypt 127.0.0.1:8080 check
